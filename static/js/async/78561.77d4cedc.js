"use strict";(self.rspackChunktest=self.rspackChunktest||[]).push([["78561"],{22616(s,n,e){e.r(n),e.d(n,{default:()=>a});var r=e(74848),i=e(28453);function l(s){let n={a:"a",code:"code",h2:"h2",h3:"h3",hr:"hr",li:"li",p:"p",pre:"pre",span:"span",strong:"strong",ul:"ul",...(0,i.R)(),...s.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:"本章节介绍 SQLite 中的事务模型、事务类型。"}),"\n",(0,r.jsx)(n.p,{children:"SQLite 的事务 API 采用**基于步骤（step-based）**的声明式模型，用于在脚本层面提供可预测、可控且安全的事务行为。"}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h2,{id:"事务概述",children:[(0,r.jsx)(n.a,{className:"rp-header-anchor","aria-hidden":"true",href:"#事务概述",children:"#"}),"事务概述"]}),"\n",(0,r.jsx)(n.p,{children:"事务用于将多条数据库操作组合为一个原子操作单元："}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"所有步骤成功执行时，事务提交"}),"\n",(0,r.jsx)(n.li,{children:"任意步骤失败时，事务回滚"}),"\n",(0,r.jsx)(n.li,{children:"回滚后数据库状态保持不变"}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h2,{id:"transcation",children:[(0,r.jsx)(n.a,{className:"rp-header-anchor","aria-hidden":"true",href:"#transcation",children:"#"}),"transcation"]}),"\n",(0,r.jsx)(r.Fragment,{children:(0,r.jsx)(n.pre,{className:"shiki css-variables",style:{backgroundColor:"var(--shiki-background)",color:"var(--shiki-foreground)"},tabIndex:"0",lang:"ts",children:(0,r.jsxs)(n.code,{children:[(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"db"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:".transcation"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"("})]}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"  steps: TranscationStep[]"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"  options"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"?:"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    kind?"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:' "deferred"'}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" |"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:' "immediate"'}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" |"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:' "exclusive"'})]}),"\n",(0,r.jsx)(n.span,{className:"line",children:(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"  }"})}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"): "}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"Promise"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"<void>"})]})]})})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"transcation"})," 用于执行一个事务，该事务由一组有序的 SQL 步骤组成。"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h2,{id:"事务步骤transcationstep",children:[(0,r.jsx)(n.a,{className:"rp-header-anchor","aria-hidden":"true",href:"#事务步骤transcationstep",children:"#"}),"事务步骤（TranscationStep）"]}),"\n",(0,r.jsx)(r.Fragment,{children:(0,r.jsx)(n.pre,{className:"shiki css-variables",style:{backgroundColor:"var(--shiki-background)",color:"var(--shiki-foreground)"},tabIndex:"0",lang:"ts",children:(0,r.jsxs)(n.code,{children:[(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"type"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:" TranscationStep"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"  sql"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" string"})]}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"  args"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"?:"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:" Arguments"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" |"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" null"})]}),"\n",(0,r.jsx)(n.span,{className:"line",children:(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"}"})})]})})}),"\n",(0,r.jsx)(n.p,{children:"每一个事务步骤包含："}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"sql"}),"：要执行的 SQL 语句"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"args"}),"：可选的参数绑定"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"示例："}),"\n",(0,r.jsx)(r.Fragment,{children:(0,r.jsx)(n.pre,{className:"shiki css-variables",style:{backgroundColor:"var(--shiki-background)",color:"var(--shiki-foreground)"},tabIndex:"0",lang:"ts",children:(0,r.jsxs)(n.code,{children:[(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"await"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" db"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:".transcation"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"(["})]}),"\n",(0,r.jsx)(n.span,{className:"line",children:(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"  {"})}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    sql"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:' "INSERT INTO user (name, age) VALUES (?, ?)"'}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    args"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" ["}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"Tom"'}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" 18"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"]"})]}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"  }"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsx)(n.span,{className:"line",children:(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"  {"})}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    sql"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:' "INSERT INTO user (name, age) VALUES (?, ?)"'}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    args"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" ["}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"Lucy"'}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" 20"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"]"})]}),"\n",(0,r.jsx)(n.span,{className:"line",children:(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"  }"})}),"\n",(0,r.jsx)(n.span,{className:"line",children:(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"])"})})]})})}),"\n",(0,r.jsx)(n.p,{children:"步骤会按照声明顺序依次执行。"}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h2,{id:"事务类型transaction-kind",children:[(0,r.jsx)(n.a,{className:"rp-header-anchor","aria-hidden":"true",href:"#事务类型transaction-kind",children:"#"}),"事务类型（Transaction Kind）"]}),"\n",(0,r.jsx)(n.p,{children:"事务支持三种类型，对应 SQLite 原生的事务模式。"}),"\n",(0,r.jsx)(r.Fragment,{children:(0,r.jsx)(n.pre,{className:"shiki css-variables",style:{backgroundColor:"var(--shiki-background)",color:"var(--shiki-foreground)"},tabIndex:"0",lang:"ts",children:(0,r.jsx)(n.code,{children:(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"kind"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"?:"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:' "deferred"'}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" |"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:' "immediate"'}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" |"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:' "exclusive"'})]})})})}),"\n",(0,r.jsxs)(n.h3,{id:"deferred",children:[(0,r.jsx)(n.a,{className:"rp-header-anchor","aria-hidden":"true",href:"#deferred",children:"#"}),"deferred"]}),"\n",(0,r.jsx)(n.p,{children:"默认事务类型。"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"事务开始时不立即获取锁"}),"\n",(0,r.jsx)(n.li,{children:"在首次读或写操作时才尝试获取锁"}),"\n",(0,r.jsx)(n.li,{children:"适合大多数普通事务场景"}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h3,{id:"immediate",children:[(0,r.jsx)(n.a,{className:"rp-header-anchor","aria-hidden":"true",href:"#immediate",children:"#"}),"immediate"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"事务开始时立即尝试获取写锁"}),"\n",(0,r.jsx)(n.li,{children:"如果无法获取写锁，将立即失败"}),"\n",(0,r.jsx)(n.li,{children:"适用于需要确保后续写操作一定能执行的场景"}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h3,{id:"exclusive",children:[(0,r.jsx)(n.a,{className:"rp-header-anchor","aria-hidden":"true",href:"#exclusive",children:"#"}),"exclusive"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"事务开始时获取排他锁"}),"\n",(0,r.jsx)(n.li,{children:"阻止其他读写操作"}),"\n",(0,r.jsx)(n.li,{children:"适用于需要完全独占数据库的特殊场景"}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h2,{id:"错误与回滚行为",children:[(0,r.jsx)(n.a,{className:"rp-header-anchor","aria-hidden":"true",href:"#错误与回滚行为",children:"#"}),"错误与回滚行为"]}),"\n",(0,r.jsx)(n.p,{children:"在事务执行过程中，如果发生以下情况："}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"SQL 执行失败"}),"\n",(0,r.jsx)(n.li,{children:"参数绑定错误"}),"\n",(0,r.jsx)(n.li,{children:"违反约束（唯一键、外键等）"}),"\n",(0,r.jsx)(n.li,{children:"数据库锁冲突"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"SQLite 将自动回滚整个事务，并抛出错误。"}),"\n",(0,r.jsx)(n.p,{children:"示例："}),"\n",(0,r.jsx)(r.Fragment,{children:(0,r.jsx)(n.pre,{className:"shiki css-variables",style:{backgroundColor:"var(--shiki-background)",color:"var(--shiki-foreground)"},tabIndex:"0",lang:"ts",children:(0,r.jsxs)(n.code,{children:[(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"try"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"  await"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" db"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:".transcation"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"(["})]}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    { sql"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:" \"INSERT INTO user (id, name) VALUES (1, 'Tom')\""}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" }"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    { sql"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:" \"INSERT INTO user (id, name) VALUES (1, 'Lucy')\""}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" }"})]}),"\n",(0,r.jsx)(n.span,{className:"line",children:(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"  ])"})}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"} "}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"catch"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" (e) {"})]}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"  console"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:".error"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"("}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"Transaction failed:"'}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" e)"})]}),"\n",(0,r.jsx)(n.span,{className:"line",children:(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"}"})})]})})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h2,{id:"使用建议",children:[(0,r.jsx)(n.a,{className:"rp-header-anchor","aria-hidden":"true",href:"#使用建议",children:"#"}),"使用建议"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"将一组必须同时成功的写操作放入同一个事务"}),"\n",(0,r.jsxs)(n.li,{children:["优先使用默认的 ",(0,r.jsx)(n.code,{children:"deferred"})," 事务类型"]}),"\n",(0,r.jsxs)(n.li,{children:["对于关键写操作，可使用 ",(0,r.jsx)(n.code,{children:"immediate"})," 提前锁定"]}),"\n",(0,r.jsx)(n.li,{children:"避免在事务中执行耗时或无关的操作"}),"\n",(0,r.jsx)(n.li,{children:"不要在事务中依赖条件分支来决定是否执行步骤"}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h2,{id:"下一步",children:[(0,r.jsx)(n.a,{className:"rp-header-anchor","aria-hidden":"true",href:"#下一步",children:"#"}),"下一步"]}),"\n",(0,r.jsx)(n.p,{children:"完成事务操作后，你可能还需要："}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"创建和管理表结构"}),"\n",(0,r.jsx)(n.li,{children:"定义索引和约束"}),"\n",(0,r.jsx)(n.li,{children:"查询数据库 Schema 信息"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"请继续阅读："}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"Schema Management"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"Schema Introspection"})}),"\n"]})]})}function a(){let s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}={...(0,i.R)(),...s.components};return n?(0,r.jsx)(n,{...s,children:(0,r.jsx)(l,{...s})}):l(s)}a.__RSPRESS_PAGE_META={},a.__RSPRESS_PAGE_META["TestFlight%2Fzh%2Fguide%2FChangelog%2F2.4.7%2FSQLite%2FTranscation.md"]={toc:[{id:"事务概述",text:"事务概述",depth:2},{id:"transcation",text:"transcation",depth:2},{id:"事务步骤transcationstep",text:"事务步骤（TranscationStep）",depth:2},{id:"事务类型transaction-kind",text:"事务类型（Transaction Kind）",depth:2},{id:"deferred",text:"deferred",depth:3},{id:"immediate",text:"immediate",depth:3},{id:"exclusive",text:"exclusive",depth:3},{id:"错误与回滚行为",text:"错误与回滚行为",depth:2},{id:"使用建议",text:"使用建议",depth:2},{id:"下一步",text:"下一步",depth:2}],title:"事务（Transcation）",headingTitle:"",frontmatter:{title:"事务（Transcation）",description:"介绍了 SQLite 的事务模型以及事务类型。",tag:"PRO"}}}}]);