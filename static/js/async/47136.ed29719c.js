"use strict";(self.rspackChunktest=self.rspackChunktest||[]).push([["47136"],{13731(s,n,e){e.r(n),e.d(n,{default:()=>o});var r=e(74848),l=e(28453);function i(s){let n={a:"a",code:"code",h2:"h2",h3:"h3",hr:"hr",li:"li",p:"p",pre:"pre",span:"span",strong:"strong",ul:"ul",...(0,l.R)(),...s.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.p,{children:["为提升长时间运行工具的用户体验，AssistantTool 新增了 ",(0,r.jsx)(n.strong,{children:"用户主动取消（Cancel）"})," 支持。\n当用户在工具执行过程中点击“取消”时，开发者可以选择性地通过 ",(0,r.jsx)(n.code,{children:"onCancel"})," 回调返回已完成的部分结果；如果未实现该回调，系统会自动处理取消逻辑，开发者无需额外处理。"]}),"\n",(0,r.jsx)(n.p,{children:"该机制适用于搜索、分析、爬取、批处理、流式生成等耗时或多阶段工具。"}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h2,{id:"能力概述",children:[(0,r.jsx)(n.a,{className:"rp-header-anchor","aria-hidden":"true",href:"#能力概述",children:"#"}),"能力概述"]}),"\n",(0,r.jsx)(n.p,{children:"新增能力包含以下 API："}),"\n",(0,r.jsx)(r.Fragment,{children:(0,r.jsx)(n.pre,{className:"shiki css-variables",style:{backgroundColor:"var(--shiki-background)",color:"var(--shiki-foreground)"},tabIndex:"0",lang:"ts",children:(0,r.jsxs)(n.code,{children:[(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"type"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:" OnCancel"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" () "}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"=>"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" string"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" |"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" null"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" |"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" undefined"})]}),"\n",(0,r.jsx)(n.span,{className:"line"}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"var"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" onCancel"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:" OnCancel"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" |"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" null"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" |"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" undefined"})]}),"\n",(0,r.jsx)(n.span,{className:"line"}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" isCancelled"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" boolean"})]})]})})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h2,{id:"核心语义说明",children:[(0,r.jsx)(n.a,{className:"rp-header-anchor","aria-hidden":"true",href:"#核心语义说明",children:"#"}),"核心语义说明"]}),"\n",(0,r.jsxs)(n.h3,{id:"oncancel-是可选实现",children:[(0,r.jsx)(n.a,{className:"rp-header-anchor","aria-hidden":"true",href:"#oncancel-是可选实现",children:"#"}),"onCancel 是可选实现"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["开发者可以选择实现 ",(0,r.jsx)(n.code,{children:"onCancel"})]}),"\n",(0,r.jsxs)(n.li,{children:["不实现 ",(0,r.jsx)(n.code,{children:"onCancel"})," 也是完全正确、被官方支持的用法"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["当开发者没有设置 ",(0,r.jsx)(n.code,{children:"onCancel"})," 时："]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"用户点击“取消”"}),"\n",(0,r.jsx)(n.li,{children:"工具会被系统标记为已取消"}),"\n",(0,r.jsx)(n.li,{children:"执行函数后续返回的任何结果都会被系统忽略"}),"\n",(0,r.jsx)(n.li,{children:"Assistant 不会消费这些返回值"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"结论是，开发者无需为“用户取消”编写任何额外逻辑，也不会产生错误行为。"}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h3,{id:"实现-oncancel-的目的",children:[(0,r.jsx)(n.a,{className:"rp-header-anchor","aria-hidden":"true",href:"#实现-oncancel-的目的",children:"#"}),"实现 onCancel 的目的"]}),"\n",(0,r.jsxs)(n.p,{children:["实现 ",(0,r.jsx)(n.code,{children:"onCancel"})," 的唯一目的，是在用户取消时主动返回“已经完成的部分结果”，以提升用户体验。"]}),"\n",(0,r.jsx)(n.p,{children:"这是一种增强能力，而不是强制要求。"}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h2,{id:"iscancelled-的语义",children:[(0,r.jsx)(n.a,{className:"rp-header-anchor","aria-hidden":"true",href:"#iscancelled-的语义",children:"#"}),"isCancelled 的语义"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"AssistantTool.isCancelled"})," 在用户取消后立即变为 ",(0,r.jsx)(n.code,{children:"true"})]}),"\n",(0,r.jsx)(n.li,{children:"该值在执行函数内随时可读取"}),"\n",(0,r.jsx)(n.li,{children:"用于控制是否继续执行后续步骤、循环或资源占用操作"}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h2,{id:"oncancel-的注册时机",children:[(0,r.jsx)(n.a,{className:"rp-header-anchor","aria-hidden":"true",href:"#oncancel-的注册时机",children:"#"}),"onCancel 的注册时机"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"onCancel"})," 必须在工具的执行函数内部注册。"]}),"\n",(0,r.jsx)(n.p,{children:"原因包括："}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["工具执行完成后，系统会自动将 ",(0,r.jsx)(n.code,{children:"onCancel"})," 设为 ",(0,r.jsx)(n.code,{children:"null"})]}),"\n",(0,r.jsx)(n.li,{children:"每次执行都是独立的生命周期"}),"\n",(0,r.jsx)(n.li,{children:"在执行函数外注册不会生效"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"可注册的位置包括："}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"registerExecuteTool"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"registerExecuteToolWithApproval"})}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h2,{id:"不实现-oncancel-的最小示例",children:[(0,r.jsx)(n.a,{className:"rp-header-anchor","aria-hidden":"true",href:"#不实现-oncancel-的最小示例",children:"#"}),"不实现 onCancel 的最小示例"]}),"\n",(0,r.jsx)(r.Fragment,{children:(0,r.jsx)(n.pre,{className:"shiki css-variables",style:{backgroundColor:"var(--shiki-background)",color:"var(--shiki-foreground)"},tabIndex:"0",lang:"ts",children:(0,r.jsxs)(n.code,{children:[(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:" executeTool"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" async"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" () "}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"=>"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"  await"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:" doSomethingSlow"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"()"})]}),"\n",(0,r.jsx)(n.span,{className:"line"}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"  return"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    success"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" true"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    message"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:' "Operation completed."'})]}),"\n",(0,r.jsx)(n.span,{className:"line",children:(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"  }"})}),"\n",(0,r.jsx)(n.span,{className:"line",children:(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"}"})})]})})}),"\n",(0,r.jsx)(n.p,{children:"行为说明："}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"用户点击取消后，工具被系统判定为已取消"}),"\n",(0,r.jsx)(n.li,{children:"上述返回结果会被自动忽略"}),"\n",(0,r.jsx)(n.li,{children:"不需要额外判断或清理逻辑"}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h2,{id:"实现-oncancel-并返回部分结果的示例",children:[(0,r.jsx)(n.a,{className:"rp-header-anchor","aria-hidden":"true",href:"#实现-oncancel-并返回部分结果的示例",children:"#"}),"实现 onCancel 并返回部分结果的示例"]}),"\n",(0,r.jsx)(r.Fragment,{children:(0,r.jsx)(n.pre,{className:"shiki css-variables",style:{backgroundColor:"var(--shiki-background)",color:"var(--shiki-foreground)"},tabIndex:"0",lang:"ts",children:(0,r.jsxs)(n.code,{children:[(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:" executeTool"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" async"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" () "}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"=>"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"  const"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" partialResults"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" string"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"[] "}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" []"})]}),"\n",(0,r.jsx)(n.span,{className:"line"}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"  AssistantTool"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"."}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:"onCancel"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" () "}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"=>"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"    return"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" ["})]}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:'      "Operation was cancelled by the user."'}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:'      "Partial results:"'}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"      ..."}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"partialResults"})]}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    ]"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:".join"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"("}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"\\n"'}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:")"})]}),"\n",(0,r.jsx)(n.span,{className:"line",children:(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"  }"})}),"\n",(0,r.jsx)(n.span,{className:"line"}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"  for"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" ("}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" item"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" of"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" items) {"})]}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"    if"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" ("}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"AssistantTool"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:".isCancelled) "}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"break"})]}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"    const"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" result"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" await"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:" process"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"(item)"})]}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"    partialResults"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:".push"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"(result)"})]}),"\n",(0,r.jsx)(n.span,{className:"line",children:(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"  }"})}),"\n",(0,r.jsx)(n.span,{className:"line"}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"  return"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    success"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" true"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    message"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" partialResults"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:".join"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"("}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"\\n"'}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:")"})]}),"\n",(0,r.jsx)(n.span,{className:"line",children:(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"  }"})}),"\n",(0,r.jsx)(n.span,{className:"line",children:(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"}"})})]})})}),"\n",(0,r.jsx)(n.p,{children:"行为说明："}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["用户取消时，",(0,r.jsx)(n.code,{children:"onCancel"})," 会被立即调用"]}),"\n",(0,r.jsxs)(n.li,{children:["已完成的 ",(0,r.jsx)(n.code,{children:"partialResults"})," 会作为 message 返回给 Assistant"]}),"\n",(0,r.jsxs)(n.li,{children:["后续执行通过 ",(0,r.jsx)(n.code,{children:"isCancelled"})," 判断及时停止"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h2,{id:"典型使用场景",children:[(0,r.jsx)(n.a,{className:"rp-header-anchor","aria-hidden":"true",href:"#典型使用场景",children:"#"}),"典型使用场景"]}),"\n",(0,r.jsxs)(n.p,{children:["适合实现 ",(0,r.jsx)(n.code,{children:"onCancel"})," 的工具类型包括："]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"多源搜索与聚合"}),"\n",(0,r.jsx)(n.li,{children:"多篇文章抓取与解析"}),"\n",(0,r.jsx)(n.li,{children:"项目级扫描与分析"}),"\n",(0,r.jsx)(n.li,{children:"批量计算或生成任务"}),"\n",(0,r.jsx)(n.li,{children:"长时间运行的推理流程"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["不适合或不需要实现 ",(0,r.jsx)(n.code,{children:"onCancel"})," 的场景包括："]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"瞬时完成的工具"}),"\n",(0,r.jsx)(n.li,{children:"没有中间结果的操作"}),"\n",(0,r.jsx)(n.li,{children:"取消后没有任何可返回内容的任务"}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h2,{id:"oncancel-的返回值规范",children:[(0,r.jsx)(n.a,{className:"rp-header-anchor","aria-hidden":"true",href:"#oncancel-的返回值规范",children:"#"}),"onCancel 的返回值规范"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"onCancel"})," 的返回值含义如下："]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["返回 ",(0,r.jsx)(n.code,{children:"string"}),"\n该字符串会作为工具被取消时返回给 Assistant 的 ",(0,r.jsx)(n.code,{children:"message"})]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["返回 ",(0,r.jsx)(n.code,{children:"null"})," 或 ",(0,r.jsx)(n.code,{children:"undefined"}),"\n表示不返回任何消息，属于合法行为，但通常不推荐"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"推荐的实践是："}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"明确说明工具已被用户取消"}),"\n",(0,r.jsx)(n.li,{children:"若返回部分结果，清楚标注为“Partial results / 已完成部分”"}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h2,{id:"与-approval-流程的关系",children:[(0,r.jsx)(n.a,{className:"rp-header-anchor","aria-hidden":"true",href:"#与-approval-流程的关系",children:"#"}),"与 Approval 流程的关系"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"onCancel"})," 发生在执行阶段"]}),"\n",(0,r.jsx)(n.li,{children:"不影响 Approval Request 阶段"}),"\n",(0,r.jsx)(n.li,{children:"适用于手动批准与 autoApprove 自动批准后的执行过程"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"需要区分的两个概念："}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"secondaryConfirmed"}),"\n表示用户在批准阶段拒绝或取消执行"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"onCancel"}),"\n表示用户在执行过程中中途取消"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h2,{id:"常见错误与注意事项",children:[(0,r.jsx)(n.a,{className:"rp-header-anchor","aria-hidden":"true",href:"#常见错误与注意事项",children:"#"}),"常见错误与注意事项"]}),"\n",(0,r.jsxs)(n.h3,{id:"在执行函数外注册-oncancel",children:[(0,r.jsx)(n.a,{className:"rp-header-anchor","aria-hidden":"true",href:"#在执行函数外注册-oncancel",children:"#"}),"在执行函数外注册 onCancel"]}),"\n",(0,r.jsx)(n.p,{children:"这是无效的用法，因为执行上下文已经结束。"}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h3,{id:"在-oncancel-中执行耗时或副作用操作",children:[(0,r.jsx)(n.a,{className:"rp-header-anchor","aria-hidden":"true",href:"#在-oncancel-中执行耗时或副作用操作",children:"#"}),"在 onCancel 中执行耗时或副作用操作"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"onCancel"})," 应快速返回，不应发起网络请求、文件写入或其他副作用操作。"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h3,{id:"忽略-iscancelled-继续执行",children:[(0,r.jsx)(n.a,{className:"rp-header-anchor","aria-hidden":"true",href:"#忽略-iscancelled-继续执行",children:"#"}),"忽略 isCancelled 继续执行"]}),"\n",(0,r.jsxs)(n.p,{children:["即使实现了 ",(0,r.jsx)(n.code,{children:"onCancel"}),"，也应在长流程中显式检查 ",(0,r.jsx)(n.code,{children:"isCancelled"}),"，避免在取消后继续消耗资源。"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h2,{id:"推荐的执行结构",children:[(0,r.jsx)(n.a,{className:"rp-header-anchor","aria-hidden":"true",href:"#推荐的执行结构",children:"#"}),"推荐的执行结构"]}),"\n",(0,r.jsx)(r.Fragment,{children:(0,r.jsx)(n.pre,{className:"shiki css-variables",style:{backgroundColor:"var(--shiki-background)",color:"var(--shiki-foreground)"},tabIndex:"0",lang:"ts",children:(0,r.jsxs)(n.code,{children:[(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:" executeTool"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" async"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" () "}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"=>"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"  const"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" partial"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" []"})]}),"\n",(0,r.jsx)(n.span,{className:"line"}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"  AssistantTool"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"."}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:"onCancel"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" () "}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"=>"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"    return"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:" formatPartialResult"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"(partial)"})]}),"\n",(0,r.jsx)(n.span,{className:"line",children:(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"  }"})}),"\n",(0,r.jsx)(n.span,{className:"line"}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"  for"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" ("}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" item"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" of"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" items) {"})]}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"    if"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" ("}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"AssistantTool"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:".isCancelled) "}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"break"})]}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"    const"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" r"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" ="}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:" await"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:" process"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"(item)"})]}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:"    partial"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:".push"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"(r)"})]}),"\n",(0,r.jsx)(n.span,{className:"line",children:(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"  }"})}),"\n",(0,r.jsx)(n.span,{className:"line"}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"  return"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:" {"})]}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    success"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-constant)"},children:" true"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"    message"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:":"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:" formatFinalResult"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"(partial)"})]}),"\n",(0,r.jsx)(n.span,{className:"line",children:(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"  }"})}),"\n",(0,r.jsx)(n.span,{className:"line",children:(0,r.jsx)(n.span,{style:{color:"var(--shiki-foreground)"},children:"}"})})]})})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h2,{id:"总结",children:[(0,r.jsx)(n.a,{className:"rp-header-anchor","aria-hidden":"true",href:"#总结",children:"#"}),"总结"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"用户取消是一种正常的用户行为，而不是异常"}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"onCancel"})," 是一种可选的体验增强能力"]}),"\n",(0,r.jsxs)(n.li,{children:["不实现 ",(0,r.jsx)(n.code,{children:"onCancel"})," 不会破坏工具行为"]}),"\n",(0,r.jsx)(n.li,{children:"系统会自动忽略取消后的执行结果"}),"\n",(0,r.jsxs)(n.li,{children:["实现 ",(0,r.jsx)(n.code,{children:"onCancel"})," 只是为了更优雅地收尾"]}),"\n"]})]})}function o(){let s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}={...(0,l.R)(),...s.components};return n?(0,r.jsx)(n,{...s,children:(0,r.jsx)(i,{...s})}):i(s)}o.__RSPRESS_PAGE_META={},o.__RSPRESS_PAGE_META["TestFlight%2Fzh%2Fguide%2FChangelog%2F2.4.7%2FAssistantTool%20User-Initiated%20Cancellation.md"]={toc:[{id:"能力概述",text:"能力概述",depth:2},{id:"核心语义说明",text:"核心语义说明",depth:2},{id:"oncancel-是可选实现",text:"onCancel 是可选实现",depth:3},{id:"实现-oncancel-的目的",text:"实现 onCancel 的目的",depth:3},{id:"iscancelled-的语义",text:"isCancelled 的语义",depth:2},{id:"oncancel-的注册时机",text:"onCancel 的注册时机",depth:2},{id:"不实现-oncancel-的最小示例",text:"不实现 onCancel 的最小示例",depth:2},{id:"实现-oncancel-并返回部分结果的示例",text:"实现 onCancel 并返回部分结果的示例",depth:2},{id:"典型使用场景",text:"典型使用场景",depth:2},{id:"oncancel-的返回值规范",text:"onCancel 的返回值规范",depth:2},{id:"与-approval-流程的关系",text:"与 Approval 流程的关系",depth:2},{id:"常见错误与注意事项",text:"常见错误与注意事项",depth:2},{id:"在执行函数外注册-oncancel",text:"在执行函数外注册 onCancel",depth:3},{id:"在-oncancel-中执行耗时或副作用操作",text:"在 onCancel 中执行耗时或副作用操作",depth:3},{id:"忽略-iscancelled-继续执行",text:"忽略 isCancelled 继续执行",depth:3},{id:"推荐的执行结构",text:"推荐的执行结构",depth:2},{id:"总结",text:"总结",depth:2}],title:"处理用户主动取消智能助手工具",headingTitle:"",frontmatter:{title:"处理用户主动取消智能助手工具",description:"为了提高用户使用长时间运行的工具的体验，智能助手工具引入了用户主动取消的支持。",tag:"PRO"}}}}]);